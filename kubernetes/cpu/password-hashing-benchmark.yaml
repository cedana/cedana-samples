apiVersion: v1
kind: Pod
metadata:
  generateName: password-hash-bench-
  namespace: default
spec:
  restartPolicy: Never
  containers:
  - name: password-hash
    image: python:3.11-slim
    resources:
      requests:
        cpu: "1"
        memory: "2Gi"
      limits:
        cpu: "4"
        memory: "4Gi"
    command:
    - bash
    - -c
    - |
      apt-get update && apt-get install -y libffi-dev build-essential --quiet
      pip install argon2-cffi bcrypt passlib scrypt --quiet
      python3 << 'EOF'
      """
      Password Hashing Benchmark

      Tests memory-hard and CPU-intensive password hashing algorithms:
      - Argon2 (winner of Password Hashing Competition)
      - bcrypt (classic, CPU-bound)
      - scrypt (memory-hard)

      These algorithms are designed to be slow and resource-intensive,
      making them interesting for checkpoint/restore testing as they
      maintain internal state during computation.
      """
      import time
      import os
      import sys
      from concurrent.futures import ThreadPoolExecutor, as_completed

      # Import hashing libraries
      from argon2 import PasswordHasher, Type
      from argon2.low_level import hash_secret_raw
      import bcrypt
      import hashlib
      import scrypt

      print("=" * 70)
      print("Password Hashing Benchmark")
      print("=" * 70)
      print()

      # Test passwords
      PASSWORDS = [
          b"short",
          b"medium_password_123",
          b"this_is_a_very_long_password_that_someone_might_actually_use_in_practice!@#$",
      ]

      def benchmark(name, func, iterations):
          """Run a hashing benchmark."""
          print(f"\n--- {name} ---")
          times = []

          for i in range(iterations):
              start = time.time()
              result = func()
              elapsed = time.time() - start
              times.append(elapsed)

              if i < 3 or i == iterations - 1:
                  print(f"  Iteration {i+1:3d}: {elapsed:.4f}s")
              elif i == 3:
                  print(f"  ... ({iterations - 4} more iterations) ...")
              sys.stdout.flush()

          avg = sum(times) / len(times)
          total = sum(times)
          print(f"  Average: {avg:.4f}s | Total: {total:.2f}s")
          return avg, total

      results = {}

      # ============================================================
      # Argon2 Benchmarks
      # ============================================================
      print("\n" + "=" * 70)
      print("ARGON2 (Password Hashing Competition Winner)")
      print("=" * 70)

      # Argon2id (recommended variant)
      ph = PasswordHasher(
          time_cost=4,       # Number of iterations
          memory_cost=65536, # 64 MB
          parallelism=4,     # 4 threads
          hash_len=32,
          type=Type.ID
      )

      def argon2_hash():
          password = PASSWORDS[1]
          return ph.hash(password.decode())

      avg, total = benchmark("Argon2id (64MB, 4 iterations)", argon2_hash, 50)
      results['argon2id_standard'] = total

      # High-security Argon2
      ph_strong = PasswordHasher(
          time_cost=8,
          memory_cost=131072,  # 128 MB
          parallelism=4,
          hash_len=32,
          type=Type.ID
      )

      def argon2_strong():
          return ph_strong.hash(PASSWORDS[1].decode())

      avg, total = benchmark("Argon2id (128MB, 8 iterations)", argon2_strong, 25)
      results['argon2id_strong'] = total

      # ============================================================
      # bcrypt Benchmarks
      # ============================================================
      print("\n" + "=" * 70)
      print("BCRYPT (Classic CPU-bound)")
      print("=" * 70)

      def bcrypt_hash_10():
          salt = bcrypt.gensalt(rounds=10)
          return bcrypt.hashpw(PASSWORDS[1], salt)

      avg, total = benchmark("bcrypt (cost=10)", bcrypt_hash_10, 50)
      results['bcrypt_10'] = total

      def bcrypt_hash_12():
          salt = bcrypt.gensalt(rounds=12)
          return bcrypt.hashpw(PASSWORDS[1], salt)

      avg, total = benchmark("bcrypt (cost=12)", bcrypt_hash_12, 20)
      results['bcrypt_12'] = total

      def bcrypt_hash_14():
          salt = bcrypt.gensalt(rounds=14)
          return bcrypt.hashpw(PASSWORDS[1], salt)

      avg, total = benchmark("bcrypt (cost=14)", bcrypt_hash_14, 10)
      results['bcrypt_14'] = total

      # ============================================================
      # scrypt Benchmarks
      # ============================================================
      print("\n" + "=" * 70)
      print("SCRYPT (Memory-hard)")
      print("=" * 70)

      def scrypt_hash_standard():
          salt = os.urandom(16)
          return scrypt.hash(PASSWORDS[1], salt, N=16384, r=8, p=1)

      avg, total = benchmark("scrypt (N=16384, r=8, p=1)", scrypt_hash_standard, 50)
      results['scrypt_standard'] = total

      def scrypt_hash_strong():
          salt = os.urandom(16)
          return scrypt.hash(PASSWORDS[1], salt, N=65536, r=8, p=1)

      avg, total = benchmark("scrypt (N=65536, r=8, p=1)", scrypt_hash_strong, 25)
      results['scrypt_strong'] = total

      # ============================================================
      # Parallel Hashing (simulating real workload)
      # ============================================================
      print("\n" + "=" * 70)
      print("PARALLEL HASHING (Real-world simulation)")
      print("=" * 70)

      def hash_password_batch(passwords, algo='argon2'):
          """Hash multiple passwords in parallel."""
          ph = PasswordHasher(time_cost=3, memory_cost=65536, parallelism=2)
          results = []
          for pw in passwords:
              if algo == 'argon2':
                  results.append(ph.hash(pw.decode()))
              elif algo == 'bcrypt':
                  salt = bcrypt.gensalt(rounds=10)
                  results.append(bcrypt.hashpw(pw, salt))
          return results

      # Generate batch of passwords
      batch_passwords = [f"user_password_{i}".encode() for i in range(100)]

      print("\n--- Batch hashing 100 passwords (Argon2) ---")
      start = time.time()
      hashed = hash_password_batch(batch_passwords, 'argon2')
      elapsed = time.time() - start
      print(f"  Total time: {elapsed:.2f}s")
      print(f"  Rate: {100/elapsed:.1f} hashes/s")
      results['batch_argon2_100'] = elapsed

      print("\n--- Batch hashing 100 passwords (bcrypt) ---")
      start = time.time()
      hashed = hash_password_batch(batch_passwords, 'bcrypt')
      elapsed = time.time() - start
      print(f"  Total time: {elapsed:.2f}s")
      print(f"  Rate: {100/elapsed:.1f} hashes/s")
      results['batch_bcrypt_100'] = elapsed

      # ============================================================
      # Summary
      # ============================================================
      print()
      print("=" * 70)
      print("BENCHMARK SUMMARY")
      print("=" * 70)
      grand_total = 0
      for name, elapsed in sorted(results.items()):
          print(f"  {name:30s}: {elapsed:8.2f}s")
          grand_total += elapsed
      print("-" * 70)
      print(f"  {'GRAND TOTAL':30s}: {grand_total:8.2f}s")
      print("=" * 70)
      print("\nPassword hashing benchmark complete!")
      EOF
