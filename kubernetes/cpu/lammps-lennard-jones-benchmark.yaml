apiVersion: v1
kind: Pod
metadata:
  generateName: lammps-md-
  namespace: default
spec:
  restartPolicy: Never
  containers:
    - name: lammps
      image: lammps/lammps:stable_29Sep2021_ubuntu20.04_openmpi_py3
      resources:
        requests:
          cpu: "1"
          memory: "2Gi"
        limits:
          cpu: "4"
          memory: "8Gi"
      command:
        - bash
        - -c
        - |
          set -e
          echo "============================================================"
          echo "LAMMPS Molecular Dynamics Simulation"
          echo "============================================================"
          echo "LAMMPS version: $(lmp_mpi -h 2>&1 | head -1 || echo 'checking...')"
          echo ""

          # Create working directory
          mkdir -p /tmp/lammps && cd /tmp/lammps

          # Create a Lennard-Jones fluid simulation input file
          # This is a classic MD benchmark that runs for many timesteps
          cat > in.lj << 'LAMMPS_INPUT'
          # 3D Lennard-Jones fluid simulation
          # A standard benchmark for molecular dynamics

          units           lj
          atom_style      atomic
          dimension       3
          boundary        p p p

          # Create simulation box and atoms
          lattice         fcc 0.8442
          region          box block 0 20 0 20 0 20
          create_box      1 box
          create_atoms    1 box
          mass            1 1.0

          # Lennard-Jones potential
          pair_style      lj/cut 2.5
          pair_coeff      1 1 1.0 1.0 2.5

          # Initial velocities (temperature = 1.44)
          velocity        all create 1.44 87287 loop geom

          # Neighbor list settings
          neighbor        0.3 bin
          neigh_modify    delay 0 every 20 check no

          # Thermodynamic output
          thermo_style    custom step temp pe ke etotal press density
          thermo          1000

          # NVE ensemble (constant energy)
          fix             1 all nve

          # Run equilibration
          print "========== EQUILIBRATION (10000 steps) =========="
          run             10000

          # Reset timer and run production
          print ""
          print "========== PRODUCTION RUN (50000 steps) =========="
          reset_timestep  0
          timer           timeout 00:30:00 every 1000

          # Dump trajectory every 5000 steps (maintains state on disk)
          dump            1 all custom 5000 dump.lammpstrj id type x y z vx vy vz

          # Run production simulation
          run             50000

          print ""
          print "========== SIMULATION COMPLETE =========="
          LAMMPS_INPUT

          echo "Input file created. Configuration:"
          echo "  - 3D Lennard-Jones fluid"
          echo "  - FCC lattice, density 0.8442"
          echo "  - Box size: 20x20x20 unit cells"
          echo "  - ~32,000 atoms"
          echo "  - 10,000 equilibration + 50,000 production steps"
          echo ""
          echo "Starting LAMMPS simulation..."
          echo "============================================================"
          echo ""

          # Run LAMMPS with MPI (1 processes)
          mpirun --allow-run-as-root -np 1 lmp_mpi -in in.lj

          echo ""
          echo "============================================================"
          echo "Simulation finished!"
          echo "Output files:"
          ls -lh /tmp/lammps/
          echo "============================================================"
